<!-- Solo se muestra la parte relevante modificada del HTML y JS -->
<div id="sistema-aura" style="display:none;">
  <div id="geo-txt">üìç Detectando ubicaci√≥n para precisi√≥n...</div>

  <!-- Input manual para ZIP -->
  <input type="text" id="manual-zip" placeholder="Ingresa tu ZIP (opcional)" style="margin-bottom:15px;">

  <button onclick="listen()" style="font-size:5rem; background:none; border:none; cursor:pointer;">üé§</button>
  <div style="position:relative; width:85%; margin:auto;">
    <input type="text" id="q" placeholder="Procedimiento, s√≠ntoma o c√≥digo (ej: MRI, D2750)">
    <button class="clear-btn" onclick="document.getElementById('q').value=''">‚úñ BORRAR</button>
  </div>
  <button class="btn-pay" onclick="getEstimate()" style="font-size:1.8rem; margin-top:20px; width:85%;" id="estimate-btn">REVELAR ESTIMADO DE PRECIO</button>
  <div id="res" class="res-box"></div>

  <div id="export-bar" style="display:none; margin-top:20px;">
    <button class="btn-ex" style="background:#25d366;" onclick="shareWA()" id="wa-btn">WhatsApp üõ°Ô∏è</button>
    <button class="btn-ex" style="background:#ffff00; color:#000;" onclick="readOut()" id="read-btn">üîä Escuchar</button>
    <button class="btn-ex" style="background:#ff9500; color:#000;" onclick="exportPDF()" id="pdf-btn">üñ®Ô∏è PDF / Print</button>
  </div>
</div>

<script>
let currentLang = 'es';
let userZip = null;

// GEO AUTOM√ÅTICO
async function getGeo() {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const { latitude, longitude } = pos.coords;
      try {
        const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=${currentLang}`);
        const data = await r.json();
        if(data.postcode) userZip = data.postcode;
        updateGeoTxt();
      } catch {
        updateGeoTxt();
      }
    }, () => { updateGeoTxt(); }, { enableHighAccuracy:true });
  } else { updateGeoTxt(); }
}

// Actualiza el texto de ubicaci√≥n
function updateGeoTxt() {
  const manualZip = document.getElementById('manual-zip').value.trim();
  if(manualZip.length === 5) {
    userZip = manualZip;
  }
  document.getElementById('geo-txt').innerText = userZip ? 
    (currentLang==='es'? `üìç Ubicaci√≥n detectada: ZIP ${userZip}` : `üìç Location detected: ZIP ${userZip}`) : 
    (currentLang==='es'? "üìç Ubicaci√≥n: USA General" : "üìç Location: USA General");
}

// Actualiza ZIP cuando el usuario escribe manualmente
document.getElementById('manual-zip').addEventListener('input', updateGeoTxt);

window.onload = () => {
  getGeo();
  if(new URLSearchParams(window.location.search).has('success')) {
    document.getElementById('paywall').style.display='none';
    document.getElementById('sistema-aura').style.display='block';
  }
};

// ESTIMADO
async function getEstimate() {
  const q = document.getElementById('q').value.trim();
  const resDiv = document.getElementById('res');
  if(!q && !userZip) return;
  resDiv.style.display='block';
  resDiv.innerHTML=currentLang==='es'? "<h2 style='color:#ffff00;'>Aura analizando mercado...</h2>" : "<h2 style='color:#ffff00;'>Aura analyzing market...</h2>";

  const fd = new FormData();
  fd.append("consulta", q);
  fd.append("lang", currentLang);
  if(userZip) fd.append("zip_user", userZip);

  try {
    const r = await fetch("/estimado",{method:"POST", body:fd});
    const d = await r.json();
    resDiv.innerText = d.resultado;
    document.getElementById('export-bar').style.display='block';
  } catch { 
    resDiv.innerText = currentLang==='es'? "Error de conexi√≥n." : "Connection error.";
  }
}
</script>
